function calcFontSize(t){function e(t){return+t.split("px")[0]}var a=d3.select(".cell-text."+jz.str.toSlugCase(t.data.name)),r=t.x1-t.x0,n=t.y1-t.y0,i=r>n?"landscape":"portrait",s=a.node().getBBox(),c=(20+s.width)/("landscape"==i?r:n),d=(20+s.height)/("landscape"==i?n:r);e(a.style("font-size"));0==r||0==n||isNaN(r)||isNaN(n)||d>1&&"BJP"!=t.data.abbr?a.text(""):c>1?a.text(t.data.abbr+", "+t.data[d3.select(".main-viz-title").text()]):a.text(t.data.name+", "+t.data[d3.select(".main-viz-title").text()])}function calcVertTextX(t){var e=t.x1-t.x0,a=t.y1-t.y0;return e>a?calcTextX(t):a>e?calcTextY(t):calcTextX(t)}function calcVertTextY(t){var e=t.x1-t.x0,a=t.y1-t.y0;return e>a?calcTextY(t):a>e?-calcTextX(t):calcTextY(t)}function calcTextRotate(t){var e=t.x1-t.x0,a=t.y1-t.y0;return e>a?"rotate(0)":a>e?"rotate(90)":""}function calcText(t){return t.x1-t.x0==0||t.y1-t.y0==0||isNaN(t.x1-t.x0)||isNaN(t.y1-t.y0)?"":t.data.name}function calcTextX(t){return isNaN(t.x1)||isNaN(t.x0)?0:(t.x1-t.x0)/2}function calcTextY(t){return isNaN(t.y1)||isNaN(t.y0)?0:(t.y1-t.y0)/2}function calcTranslate(t){return isNaN(t.x0)||isNaN(t.y0)?"translate(0, 0)":"translate("+t.x0+","+t.y0+")"}function rectToPath(t,e,a,r){return a=a?a:0,r=r?r:0,"M"+a+","+r+" H"+t+" V"+e+" H"+a+" Z"}function rectToRounded(t,e,a,r){var n=5;n=e<n||e<n?d3.min([t,e]):n,a=a?a:0,r=r?r:0;var i="M"+(a+n)+","+r,s="H"+(t-n),c="C"+(t-n)+","+r+" "+t+","+r+" "+t+","+(r+n),d="V"+(e-n),l="C"+t+","+(e-n)+" "+t+","+e+" "+(t-n)+","+e,o="H"+(a+n),u="C"+(a+n)+","+e+" "+a+","+e+" "+a+","+(e-n),f="V"+(r+n),x="C"+a+","+(r+n)+" "+a+","+r+" "+(a+n)+","+r;return isNaN(t)||isNaN(e)?"":i+" "+s+" "+c+" "+d+" "+l+" "+o+" "+u+" "+f+" "+x}function makeBar(){function t(t,n,i){var s={seats:n,votes:i},c=e(s.seats);m.keys(c),u.domain(s.seats.map(function(t){return t.year})),o.append("g").attr("class","x axis").attr("transform","translate(0,"+l+")").call(x),o.append("g").attr("class","y axis").call(r),a(s[$(".toggle-item.active").attr("data-which")],c,$(".toggle-item.active").attr("data-which")),$(".toggle-item").click(function(){if(!$(this).hasClass("active")){$(".toggle-item.active").removeClass("active"),$(this).addClass("active");var t=$(".toggle-item.active").attr("data-which");a(s[t],c,t),$(".data-type").html(jz.str.removeLast(t,"s"))}})}function e(t){return Object.keys(t[0]).filter(function(t){return"year"!=t&&"sum"!=t})}function a(t,e,a){f.domain([0,d3.max(t.map(function(t){return t.sum}))]),h.tickFormat(function(t,e,r){return e==r.length-1?t+"% of "+a:t}),o.select(".y").transition().call(r),e.forEach(function(e,a){function r(t){return"0"==t.data[e]||f(t[0])-f(t[1])<10||mob&&"Indian National Congress"!=e&&"Bharatiya Janata Party"!=e?null:Number(t.data[e]).toFixed(n.txt_fixed)}var s=(m(t).filter(function(t){return t.key==e})[0],o.selectAll(".bar-"+jz.str.toSlugCase(e)).data(m(t).filter(function(t){return t.key==e})[0],function(t){return t.data.year+"-"+jz.str.toSlugCase(e)})),c=o.selectAll(".txt-"+jz.str.toSlugCase(e)).data(m(t).filter(function(t){return t.key==e})[0],function(t){return t.data.year+"-"+jz.str.toSlugCase(e)});s.transition().attr("x",function(t){return u(t.data.year)}).attr("y",function(t){return f(t[1])}).attr("height",function(t){return f(t[0])-f(t[1])}),c.transition().attr("x",function(t){return u(t.data.year)+u.bandwidth()/2}).attr("y",function(t){return f(t[1])}).text(r),s.enter().append("rect").attr("class",function(t){return"bar bar-"+jz.str.toSlugCase(e)}).attr("x",function(t){return u(t.data.year)}).attr("y",function(t){return f(t[1])}).attr("height",function(t){return f(t[0])-f(t[1])}).attr("width",u.bandwidth()).attr("fill",function(t){return i[e]}),c.enter().append("text").attr("class",function(t){return"txt txt-"+jz.str.toSlugCase(e)}).attr("x",function(t){return u(t.data.year)+u.bandwidth()/2}).attr("y",function(t){return f(t[1])}).attr("dy",mob?8:12).text(r)})}function r(t){t.call(h),t.selectAll(".tick:not(:first-of-type) line").attr("stroke",mob?"#eee":"#888").attr("stroke-dasharray","2,2"),t.selectAll(".tick text").attr("x",4).attr("dy",-4)}var n={height_divide:mob?1.5:2,bar_pad:mob?.5:.25,txt_fixed:mob?0:1};$("#stacked").empty();var i={"Indian National Congress":"#2880b9","Bharatiya Janata Party":"#e27a3f","Congress faction":"#71afd8","BJP predecessor":"#ffb992",Other:"#eee"},s=d3.min([850,window.innerWidth-10]),c=d3.marcon().top(20).bottom(20).left(0).right(mob?1:0).width(s).height(s/n.height_divide).element("#stacked");c.render();var d=c.innerWidth(),l=c.innerHeight(),o=c.svg(),u=d3.scaleBand().rangeRound([0,d]).padding(n.bar_pad),f=d3.scaleLinear().rangeRound([l,0]),x=d3.axisBottom(u).tickFormat(function(t,e){return mob?0==e?t:"2002"==t?t:"'"+jz.str.keepEnd(t,2):t}),h=d3.axisRight(f).tickSize(d),m=d3.stack().order(d3.stackOrderNone).offset(d3.stackOffsetNone);d3.queue().defer(d3.csv,"data/seatshare.csv").defer(d3.csv,"data/votes.csv").await(t)}var mob=isMobile.any,width=d3.min([850,window.innerWidth-10]),height=width/2,svg=d3.select("#viz").append("svg").attr("width",width).attr("height",height),color={INC:"#2880b9",BJP:"#e27a3f",BJS:"#ffb992",NCO:"#71afd8","INC(I)":"#71afd8"},playing=!0,treemap=d3.treemap().tile(d3.treemapResquarify).size([width,height]).round(!0).paddingInner(5),slider_m=d3.marcon().height(60).width(d3.min([500,window.innerWidth-10])).left(20).right(20).top(10).bottom(20).element("#slider");slider_m.render();var slider_width=slider_m.innerWidth(),slider_height=slider_m.innerHeight(),slider_svg=slider_m.svg(),slider_bar_height=10,slider_x=d3.scaleBand().range([0,slider_width]),slider_radius=slider_height/1.5,slider_axis=d3.axisBottom().scale(slider_x).tickFormat(function(t,e){return mob?0==e?t:"2002"==t?t:"'"+jz.str.keepEnd(t,2):t});d3.json("data/tree.json",function(t,e){function a(){playing||(playing=!0,$(".play").removeClass("paused").addClass("playing").html("<i class='fa fa-pause' aria-hidden='true'></i> Pause"),$(".slider-circle").css("cursor","default"),n(),r())}function r(){function t(){playing=!1,$(".play").removeClass("playing").addClass("paused").html("<i class='fa fa-play' aria-hidden='true'></i> Play"),$(".slider-circle").css("cursor","ew-resize"),e.stop()}var e=d3.interval(n,1e3);$(document).on("mouseenter","#viz",t),$(document).on("click",".play.playing",t)}function n(){function t(t){return c.indexOf(d)}var e=t(d),a=e==c.length-1?0:e+1,r=c[a];s(r);var n=slider_x(r)+slider_x.step()/2;d3.select(".slider-circle").attr("cx",n),d=r}function i(){var t=slider_x.domain().length-1,e=d3.event.x<0?0:d3.event.x>slider_width?slider_width:d3.event.x,a=Math.round(e/slider_width*t),r=slider_x.domain()[a],n=slider_x(r)+slider_x.step()/2;d3.select(".slider-circle").attr("cx",n),r!=d&&s(r)}function s(t){d3.select(".main-viz-title").html(t),d=t,treemap(l.sum(function(e){return e[t]})),o.transition().attr("transform",calcTranslate).select("path").attr("d",function(t){return rectToRounded(t.x1-t.x0,t.y1-t.y0)}),o.transition().attr("transform",calcTranslate).select("text").attr("transform",calcTextRotate).attr("x",calcVertTextX).attr("y",calcVertTextY).text(calcText).style("font-size",function(t){d3.timeout(function(){return calcFontSize(t)},0)})}if(t)throw t;var c=Object.keys(e.children[0]).filter(function(t){return"name"!=t&&"abbr"!=t});slider_x.domain(c);var d=c[0];slider_svg.append("rect").attr("class","slider-rect").attr("x",0).attr("y",0).attr("rx",5).attr("ry",5).attr("width",slider_width).attr("height",10),slider_svg.append("g").attr("class","slider-axis").attr("transform","translate(0, 20)").call(slider_axis),slider_svg.append("circle").attr("class","slider-circle").attr("cx",slider_x(c[0])+slider_x.step()/2).attr("cy",5).attr("r",10).call(d3.drag().on("drag",function(){playing||i()}));var l=d3.hierarchy(e).eachBefore(function(t){t.data.id=(t.parent?t.parent.data.id+".":"")+t.data.name}).sum(function(t){return t[d]}).sort(function(t,e){return e.height-t.height||e.value-t.value});treemap(l);var o=svg.selectAll("g").data(l.leaves()).enter().append("g").attr("transform",calcTranslate);o.append("path").attr("id",function(t){return t.data.id}).attr("d",function(t){return rectToRounded(t.x1-t.x0,t.y1-t.y0)}).style("fill",function(t){return color[t.data.abbr]}),o.append("text").attr("class",function(t){return"cell-text "+jz.str.toSlugCase(t.data.name)}).attr("dy",8).attr("transform",calcTextRotate).attr("x",calcVertTextX).attr("y",calcVertTextY).style("text-anchor","middle").text(calcText).style("font-size",calcFontSize),r(),$(document).on("mouseleave","#viz svg",a),$(document).on("click",".play.paused",a)}),makeBar();